{% load static %}

{% now "Y" as current_year %}

{% for note in notes %}
  <div class="card p-2 shadow-sm h-100 position-relative">
    <!-- ðŸ”¹ Tag as pill badge (top-right corner) -->
    <span
      class="note-tag badge rounded-pill position-absolute top-0 end-0 m-2"
      style="background-color: {{ note.color }};z-index: 1;"
    >
      {{ note.tag| default:"&nbsp" }}
    </span>

    <!-- ðŸ”¹ Bootstrap Carousel for note images -->
    {% if note.note_image_set.all %}
      <div
        id="carouselNote{{ note.note_id }}"
        class="carousel slide border rounded-top"
        data-bs-ride="carousel"
        style="height: {{ note.max_height }}px;"
      >
        <div class="carousel-inner">
          {% for img in note.processed_images %}
            <div
              class="carousel-item {% if forloop.first %}active{% endif %}"
              style="padding: {{ img.half_diff }}px 0;"
            >
              <img
                src="{{ img.image.url }}"
                class="d-block card-img w-100 rounded-top"
                alt="Note image"
              />
            </div>
          {% endfor %}
        </div>
        {% if note.note_image_set.count > 1 %}
          <!-- Carousel controls -->
          <button
            class="carousel-control-prev"
            type="button"
            data-bs-target="#carouselNote{{ note.note_id }}"
            data-bs-slide="prev"
          >
            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Previous</span>
          </button>
          <button
            class="carousel-control-next"
            type="button"
            data-bs-target="#carouselNote{{ note.note_id }}"
            data-bs-slide="next"
          >
            <span class="carousel-control-next-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Next</span>
          </button>
        {% endif %}
      </div>
    {% endif %}

    <!-- ðŸ”¹ Card Body -->
    <div class="card-body">
      <h1 class="card-title fw-bold opacity-25">{{ note.title|default:"" }}</h1>

      <!-- Description -->
      <p class="card-text">
        <div class="note-description">
          {{ note.formatted_description | safe }}
        </div>
      </p>

      <!-- Footer -->
      <div class="d-flex justify-content-between align-items-center mt-3">
        <div>
          <a
            href="edit/{{note.note_id}}/"
            class="btn btn-sm btn-outline-accent"
            ><i class="bi bi-pen"></i> Edit</a
          >
          <button
            class="btn btn-sm btn-danger"
            data-bs-toggle="modal"
            data-bs-target="#deleteModal"
            data-type="note"
            data-note-id="{{ note.note_id }}"
          ><i class="bi bi-trash"></i> Delete Note</button>
        </div>
        <small class="text-muted">
          Edited at {{ note.updated_at|date:"d M" }}
          {% if note.updated_at|date:"Y" != current_year %} {{ note.updated_at|date:"Y" }} {% endif %}
        </small>
      </div>
    </div>
  </div>
{% endfor %}
